USE [ArlaCompass]
GO

CREATE PROCEDURE [dbo].[rptMarketReturnArla]
@OutletIDs VARCHAR(MAX), @StatusID int, @SKUIDs VARCHAR(MAX), @RouteIDs VARCHAR(MAX),@startDate DATETIME,@endDate DATETIME
AS 
SET NOCOUNT ON;

--DECLARE
--@OutletIDs VARCHAR(MAX)='297927,297928', @StatusID INT = -1,
--@SKUIDs VARCHAR(MAX)='7646,7696,7706,7647,7697,7707,7648,7699,7708,7649,7698,7710,7650,7700,7711,7652,7701,7712,7651,7702,7713,7653,7714,7654,7715,7656,7655,7657,7716,7658,7717,7659,7709,7694,7660,7720,7661,7662,7718,7663,7664,7719,7669,7721,7723,7665,7703,7695,7704,7722,7676,7705,7679,7680,7681,7683,7685,7684,7687,7688,7686,7689,7690,7691,7692,7693', 
----@SKUIDs VARCHAR(MAX)='7655,765', 
--@RouteIDs VARCHAR(MAX)='13394,13395,13396,13397,13398,13399,13400,13401,13402,13403,13404,13405,13406,13407,13408,13409,13410,13411,13412,13413,13414,13415,13416,13417,13418,13419,13420,13421,13422,13423,13424,13425,13426,13427,13428,13429,13430,13431,13432,13433,13434,13435,13436,13437,13438,13439,13440,13441,13442,13443,13444,13445,13446,13447,13448,13449,13450,13451,13452,13453,13454,13455,13456,13457,13458,13459,13460,13461,13462,13463,13464,13465,13466,13467,13468,13469,13470,13471,13472,13473,13474,13475,13476,13477,13478,13479,13480,13481,13482,13483,13484,13485,13486,13487,13488,13489,13490,13491,13492,13493,13494,13495,13496,13497,13498,13499,13500,13501,13502,13503,13504,13505,13506,13507,13508',@startDate DATETIME = '1 Dec 2019',@endDate DATETIME = '31 Dec 2019'

  
IF @StatusID < 0
BEGIN
	SET @StatusID=NULL;
END
	
SET @SKUIDs= NULLIF(@SKUIDs, '');

SELECT ch.Name ChannelName, r.Name RouteName,c.Code OutletCode, c.Name OutletName,
e.Name SRName, mr.MarketReturnNo, mr.MarketReturnDate, s.Code SKUCode, s.Name SKUName, mri.BatchNo, sar.Name Reason,
(
	CASE mr.[status] 
	WHEN 0 THEN 'NewEntry'
	WHEN 1 THEN 'Pending'
	WHEN 2 THEN 'AttachedToMemo'
	WHEN 3 THEN 'Adjusted'
	WHEN 16 THEN 'Authorized' END
) [Status],
SUM(mri.InvoicePrice) UnitPrice, SUM(mri.Quantity) Qty,
SUM(mri.InvoicePrice*mri.Quantity) VALUE, CONVERT(DECIMAL(10,2), SUM(mri.Quantity * s.[Weight] * 0.001)) [Weight]
FROM  MarketReturnItem AS mri
INNER JOIN  MarketReturns AS mr ON mr.MarketReturnID=mri.MarketReturnID
--INNER JOIN Employees AS e ON mr.SRID=e.EmployeeID
--INNER JOIN SKUs AS s ON s.SKUID = mri.SKUID
--INNER JOIN StockAdjustmentReasons AS sar ON mr.ReasonID=sar.ReasonID
--INNER JOIN [Routes] AS r ON mr.RouteID= r.RouteID
--INNER JOIN Customers AS c ON mr.CustomerID = c.CustomerID
--LEFT JOIN Channels AS ch ON ch.ChannelID = c.ChannelID

INNER JOIN SKUs AS s ON s.SKUID = mri.SKUID 
INNER JOIN Employees AS e ON e.EmployeeID=mr.SRID
INNER JOIN Routes AS r ON r.RouteID=mr.RouteID
INNER JOIN SalesPoints AS sp ON sp.SalesPointID=mr.SalesPointID
INNER JOIN StockAdjustmentReasons AS sar ON sar.ReasonID=mr.ReasonID
INNER JOIN Customers AS c ON c.CustomerID=mr.CustomerID 
LEFT JOIN Channels AS ch ON ch.ChannelID = c.ChannelID

WHERE 
s.SKUID IN (SELECT * FROM STRING_SPLIT(@SKUIDs, ',')) 
AND mr.RouteID IN (SELECT * FROM STRING_SPLIT(@RouteIDs, ',')) 
AND CAST(mr.MarketReturnDate AS DATE) BETWEEN CAST(@startDate AS DATE) AND CAST(@endDate AS DATE)
--AND mr.CustomerID IN (SELECT NUMBER FROM dbo.STRING_TO_INT(@OutletIDs)) 
AND mr.[Status] = ISNULL(@StatusID, mr.[Status])

GROUP BY
ch.Name, r.Name, c.Code, c.Name,
e.Name, mr.MarketReturnNo, mr.MarketReturnDate, s.Code, s.Name,
mri.BatchNo, sar.Name,mr.[Status] 

ORDER BY mr.MarketReturnDate 

SET NOCOUNT OFF;
